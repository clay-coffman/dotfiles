# Zsh/Zim Configuration


# ENV VARIABLES
export LANG=en_US.UTF-8
export EDITOR=nvim
export XDG_CONFIG_HOME="{{ .chezmoi.homeDir }}/.config"
export XDG_CACHE_HOME="${XDG_CACHE_HOME:-{{ .chezmoi.homeDir }}/.cache}"
export XDG_DATA_HOME="${XDG_DATA_HOME:-{{ .chezmoi.homeDir }}/.local/share}"
export XDG_STATE_HOME="${XDG_STATE_HOME:-{{ .chezmoi.homeDir }}/.local/state}"
{{ if eq .chezmoi.os "linux" -}}
export XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/run/user/$(id -u)}"
{{- end }}
export GEMINI_API_KEY="{{ onepasswordRead "op://Private/Gemini API Key 1/credential" }}"
export GITHUB_TOKEN="{{ onepasswordRead "op://Private/Github Token - macbook-air-2/credential" }}"
export REF_API_KEY="{{ onepasswordRead "op://Private/Ref API Key/credential" }}"
export CONTEXT7_API_KEY="{{ onepasswordRead "op://Private/Context7 API Key/credential" }}"

# GLOBAL CONFIG FILES
export PRETTIERD_DEFAULT_CONFIG="$XDG_CONFIG_HOME/.prettierrc.yaml"
export TAPLO_CONFIG="$XDG_CONFIG_HOME/taplo.toml"

# path to rgignore
export RIPGREP_CONFIG_PATH="{{ .chezmoi.homeDir }}/.config/ripgrep/config"

# PATH
# Base PATH - platform agnostic
export PATH="$HOME/bin:$HOME/.local/bin:$PATH"

{{ if eq .chezmoi.os "darwin" -}}
# macOS specific paths
export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"

# LLVM (Homebrew)
export PATH="/opt/homebrew/opt/llvm/bin:$PATH"
export LDFLAGS="-L/opt/homebrew/opt/llvm/lib"
export CPPFLAGS="-I/opt/homebrew/opt/llvm/include"

# PostgreSQL 16 (Homebrew)
export PATH="/opt/homebrew/opt/postgresql@16/bin:$PATH"

# pnpm (macOS)
export PNPM_HOME="{{ .chezmoi.homeDir }}/Library/pnpm"
{{- else if eq .chezmoi.os "linux" -}}
# Linux specific paths
# System packages are usually already in PATH (/usr/bin, /usr/local/bin)

# LLVM (if installed via system package manager)
# Fedora/RHEL: llvm-toolset-XX
# Ubuntu/Debian: llvm-XX
if [ -d "/usr/lib/llvm-18/bin" ]; then
    export PATH="/usr/lib/llvm-18/bin:$PATH"
    export LDFLAGS="-L/usr/lib/llvm-18/lib"
    export CPPFLAGS="-I/usr/lib/llvm-18/include"
elif [ -d "/usr/lib64/llvm18/bin" ]; then
    # Fedora style
    export PATH="/usr/lib64/llvm18/bin:$PATH"
    export LDFLAGS="-L/usr/lib64/llvm18/lib"
    export CPPFLAGS="-I/usr/lib64/llvm18/include"
fi

# PostgreSQL (usually in /usr/bin, but can check for specific versions)
if [ -d "/usr/pgsql-16/bin" ]; then
    export PATH="/usr/pgsql-16/bin:$PATH"
elif [ -d "/usr/lib/postgresql/16/bin" ]; then
    export PATH="/usr/lib/postgresql/16/bin:$PATH"
fi

# pnpm (Linux - XDG compliant)
export PNPM_HOME="${XDG_DATA_HOME:-$HOME/.local/share}/pnpm"
{{- end }}
case ":$PATH:" in
  *":$PNPM_HOME:"*) ;;
  *) export PATH="$PNPM_HOME:$PATH" ;;
esac

# cache completions
zstyle ':completion:*' use-cache on
zstyle ':completion:*' cache-path "$XDG_CACHE_HOME/zsh/zcompcache"

# SHELL OPTIONS
# History configuration (XDG-compliant)
HISTFILE="${XDG_STATE_HOME:-$HOME/.local/state}/zsh/history"
# Ensure the directory exists
[[ ! -d "$(dirname "$HISTFILE")" ]] && mkdir -p "$(dirname "$HISTFILE")"
HISTSIZE=10000
SAVEHIST=10000
setopt HIST_IGNORE_ALL_DUPS  # Remove older duplicates
setopt APPEND_HISTORY         
setopt SHARE_HISTORY         
setopt HIST_EXPIRE_DUPS_FIRST  # Expire duplicates first when trimming
setopt HIST_FIND_NO_DUPS       # Don't show duplicates in search
setopt HIST_REDUCE_BLANKS      # Remove superfluous blanks
setopt HIST_VERIFY             # Show command before executing from history
setopt INC_APPEND_HISTORY      # Add to history immediately, not on exit

# Directory navigation
setopt AUTO_CD                # Change directory by typing directory name
setopt EXTENDED_GLOB          # Enable extended globbing patterns

# Command correction
setopt CORRECT                
SPROMPT='zsh: correct %F{red}%R%f to %F{green}%r%f [nyae]? '

# Input/output
bindkey -v                    
WORDCHARS=${WORDCHARS//[\/]}  

# FZF configuration
export FZF_DEFAULT_COMMAND='rg --files --hidden --follow --glob "!.git/*"'
export FZF_DEFAULT_OPTS="--height 40% --reverse --border --preview 'bat --color=always {}' --preview-window=right:60%:wrap"
export FZF_CTRL_T_OPTS="--preview '(bat --color=always {} 2> /dev/null || tree -C {}) 2> /dev/null | head -200'"
export FZF_ALT_C_OPTS="--preview 'tree -C {} | head -200'"

# COMPLETIONS
if [[ ":$FPATH:" != *":{{ .chezmoi.homeDir }}/.zsh/completions:"* ]]; then 
  export FPATH="{{ .chezmoi.homeDir }}/.zsh/completions:$FPATH"
fi

# Docker
if [[ -d "{{ .chezmoi.homeDir }}/.docker/completions" ]]; then
  fpath=("{{ .chezmoi.homeDir }}/.docker/completions" $fpath)
fi

# Oh-my-zsh config
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME=""

# Fix zcompdump location - use a consistent path
export ZSH_COMPDUMP="$XDG_CACHE_HOME/zsh/zcompdump"

# Ensure the directory exists
[[ ! -d "$XDG_CACHE_HOME/zsh" ]] && mkdir -p "$XDG_CACHE_HOME/zsh"

# --- zsh-vi-mode ---
# Start each new command line in insert mode (you can switch to normal with <Esc>)
ZVM_LINE_INIT_MODE=$ZVM_MODE_INSERT

# Snappy key handling (seconds)
ZVM_KEYTIMEOUT=0.40
ZVM_ESCAPE_KEYTIMEOUT=0.03

# Clipboard integration: gp/gP use system clipboard; yanks copy to it
ZVM_SYSTEM_CLIPBOARD_ENABLED=true

# (Optional) Surround keymap: "classic" (ys/cs/ds) or "s-prefix" (sa/sr/sd)
# ZVM_VI_SURROUND_BINDKEY=classic

# OMZ plugins
plugins=(git alias-finder asdf zoxide zsh-vi-mode)

source $ZSH/oh-my-zsh.sh

# Load asdf (version manager)
{{ if eq .chezmoi.os "darwin" -}}
# macOS: asdf installed via Homebrew
[ -f /opt/homebrew/opt/asdf/libexec/asdf.sh ] && source /opt/homebrew/opt/asdf/libexec/asdf.sh
{{- else if eq .chezmoi.os "linux" -}}
# Linux: asdf installed via git
[ -f "$HOME/.asdf/asdf.sh" ] && source "$HOME/.asdf/asdf.sh"
# Load asdf completions for Zsh
if [ -f "$HOME/.asdf/completions/_asdf" ]; then
  fpath=($HOME/.asdf/completions $fpath)
fi
{{- end }}


# CUSTOM FUNCTIONS AND ALIASES
alias v="nvim"
alias c="clear"
alias l="ls -la"

# use bat instead of cat
alias cat="bat --theme auto:system"

alias bake="mbake"

{{ if eq .chezmoi.os "darwin" -}}
# macOS-specific aliases
alias finder='open -R'
alias flushdns='sudo dscacheutil -flushcache; sudo killall -HUP mDNSResponder'
{{- else if eq .chezmoi.os "linux" -}}
# Linux-specific aliases
alias open='xdg-open'  # Opens files/URLs with default application

# Clipboard aliases (requires xclip for X11 or wl-clipboard for Wayland)
if command -v wl-copy &> /dev/null; then
    # Wayland clipboard
    alias pbcopy='wl-copy'
    alias pbpaste='wl-paste'
elif command -v xclip &> /dev/null; then
    # X11 clipboard
    alias pbcopy='xclip -selection clipboard'
    alias pbpaste='xclip -selection clipboard -o'
fi

# System-specific aliases
if command -v dnf &> /dev/null; then
    # Fedora/RHEL
    alias update='sudo dnf update'
    alias search='dnf search'
    alias install='sudo dnf install'
elif command -v apt &> /dev/null; then
    # Ubuntu/Debian
    alias update='sudo apt update && sudo apt upgrade'
    alias search='apt search'
    alias install='sudo apt install'
fi
{{- end }}

# initializes project mcp file with base mcp servers
mcp-init() {
    local project_dir="${1:-.}"
    cd "$project_dir"
    
    # Copy or merge base config
    ~/.config/scripts/merge-claude-config.sh
    
    # Optional: add project-specific servers
    if [ -n "$2" ]; then
        echo "Add project-specific servers to .mcp.json"
    fi
}

# Yazi with directory change on exit
function y() {
    local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
    yazi "$@" --cwd-file="$tmp"
    if IFS= read -r -d '' cwd < "$tmp" && [ -n "$cwd" ] && [ "$cwd" != "$PWD" ]; then
        builtin cd -- "$cwd"
    fi
    rm -f -- "$tmp"
}

# Starship prompt
eval "$(starship init zsh)"

# atuin (shell history)
eval "$(atuin init zsh)"
