
###################################################################################################
# ENV Vars + Path stuff
###################################################################################################

export LANG=en_US.UTF-8
export EDITOR=nvim
export XDG_CONFIG_HOME="{{ .chezmoi.homeDir }}/.config"
export XDG_CACHE_HOME="${XDG_CACHE_HOME:-{{ .chezmoi.homeDir }}/.cache}"
export XDG_DATA_HOME="${XDG_DATA_HOME:-{{ .chezmoi.homeDir }}/.local/share}"
export XDG_STATE_HOME="${XDG_STATE_HOME:-{{ .chezmoi.homeDir }}/.local/state}"
{{ if eq .chezmoi.os "linux" -}}
export XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-/run/user/$(id -u)}"
{{- end }}
export GEMINI_API_KEY="{{ onepasswordRead "op://Private/Gemini API Key 1/credential" }}"
export GITHUB_TOKEN="{{ onepasswordRead "op://Private/Github Token - macbook-air-2/credential" }}"
export REF_API_KEY="{{ onepasswordRead "op://Private/Ref API Key/credential" }}"
export CONTEXT7_API_KEY="{{ onepasswordRead "op://Private/Context7 API Key/credential" }}"

# GLOBAL CONFIG FILES
export PRETTIERD_DEFAULT_CONFIG="$XDG_CONFIG_HOME/.prettierrc.yaml"
export TAPLO_CONFIG="$XDG_CONFIG_HOME/taplo.toml"
export RIPGREP_CONFIG_PATH="{{ .chezmoi.homeDir }}/.config/ripgrep/config"

# PATH
export PATH="$HOME/bin:$HOME/.local/bin:$PATH"

###################################################################################################
# macOS specific
###################################################################################################

{{ if eq .chezmoi.os "darwin" -}}
export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"

# LLVM 
export PATH="/opt/homebrew/opt/llvm/bin:$PATH"
export LDFLAGS="-L/opt/homebrew/opt/llvm/lib"
export CPPFLAGS="-I/opt/homebrew/opt/llvm/include"

# PostgreSQL 16
export PATH="/opt/homebrew/opt/postgresql@16/bin:$PATH"

# pnpm
export PNPM_HOME="{{ .chezmoi.homeDir }}/Library/pnpm"

{{- end }}


###################################################################################################
# Shell Options
###################################################################################################

# cache completions
zstyle ':completion:*' use-cache on
zstyle ':completion:*' cache-path "$XDG_CACHE_HOME/zsh/zcompcache"

# SHELL OPTIONS
HISTFILE="${XDG_STATE_HOME:-$HOME/.local/state}/zsh/history"
[[ ! -d "$(dirname "$HISTFILE")" ]] && mkdir -p "$(dirname "$HISTFILE")"
HISTSIZE=10000
SAVEHIST=10000
setopt HIST_IGNORE_ALL_DUPS  
setopt APPEND_HISTORY         
setopt SHARE_HISTORY         
setopt HIST_EXPIRE_DUPS_FIRST 
setopt HIST_FIND_NO_DUPS       
setopt HIST_REDUCE_BLANKS     
setopt HIST_VERIFY             
setopt INC_APPEND_HISTORY     
setopt AUTO_CD                
setopt EXTENDED_GLOB         
setopt CORRECT                
SPROMPT='zsh: correct %F{red}%R%f to %F{green}%r%f [nyae]? '

bindkey -v                    
WORDCHARS=${WORDCHARS//[\/]}  


###################################################################################################
# Other
###################################################################################################

# FZF configuration
export FZF_DEFAULT_COMMAND='rg --files --hidden --follow --glob "!.git/*"'
export FZF_DEFAULT_OPTS="--height 40% --reverse --border --preview 'bat --color=always {}' --preview-window=right:60%:wrap"
export FZF_CTRL_T_OPTS="--preview '(bat --color=always {} 2> /dev/null || tree -C {}) 2> /dev/null | head -200'"
export FZF_ALT_C_OPTS="--preview 'tree -C {} | head -200'"

source <(fzf --zsh)

# COMPLETIONS
if [[ ":$FPATH:" != *":{{ .chezmoi.homeDir }}/.zsh/completions:"* ]]; then 
  export FPATH="{{ .chezmoi.homeDir }}/.zsh/completions:$FPATH"
fi

# Docker
if [[ -d "{{ .chezmoi.homeDir }}/.docker/completions" ]]; then
  fpath=("{{ .chezmoi.homeDir }}/.docker/completions" $fpath)
fi

# Oh-my-zsh config
export ZSH="$HOME/.oh-my-zsh"
ZSH_THEME=""

# Fix zcompdump location - use a consistent path
export ZSH_COMPDUMP="$XDG_CACHE_HOME/zsh/zcompdump"

# Ensure the directory exists
[[ ! -d "$XDG_CACHE_HOME/zsh" ]] && mkdir -p "$XDG_CACHE_HOME/zsh"

# --- zsh-vi-mode ---
# Start each new command line in insert mode (you can switch to normal with <Esc>)
ZVM_LINE_INIT_MODE=$ZVM_MODE_INSERT
ZVM_KEYTIMEOUT=0.40
ZVM_ESCAPE_KEYTIMEOUT=0.03
ZVM_SYSTEM_CLIPBOARD_ENABLED=true
# ZVM_VI_SURROUND_BINDKEY=classic

# OMZ plugins
plugins=(git alias-finder asdf zoxide zsh-vi-mode)

source $ZSH/oh-my-zsh.sh

# Load asdf (version manager)
{{ if eq .chezmoi.os "darwin" -}}
# macOS: asdf installed via Homebrew
[ -f /opt/homebrew/opt/asdf/libexec/asdf.sh ] && source /opt/homebrew/opt/asdf/libexec/asdf.sh
{{- else if eq .chezmoi.os "linux" -}}
# Linux: asdf installed via git
[ -f "$HOME/.asdf/asdf.sh" ] && source "$HOME/.asdf/asdf.sh"
# Load asdf completions for Zsh
if [ -f "$HOME/.asdf/completions/_asdf" ]; then
  fpath=($HOME/.asdf/completions $fpath)
fi
{{- end }}


###################################################################################################
# Custom Funcs and Aliases
###################################################################################################
alias v="nvim"
alias c="clear"
alias l="ls -la"

# use bat instead of cat
alias cat="bat"
alias bake="mbake"

{{ if eq .chezmoi.os "darwin" -}}
alias finder='open -R'
alias flushdns='sudo dscacheutil -flushcache; sudo killall -HUP mDNSResponder'

{{- else if eq .chezmoi.os "linux" -}}
alias open='xdg-open' 

# clipboard
if command -v wl-copy &> /dev/null; then
    alias pbcopy='wl-copy'
    alias pbpaste='wl-paste'
elif command -v xclip &> /dev/null; then
    alias pbcopy='xclip -selection clipboard'
    alias pbpaste='xclip -selection clipboard -o'
fi

alias update='sudo dnf update'
alias search='dnf search'
alias install='sudo dnf install'

{{- end }}

# initializes project mcp file with base mcp servers
mcp-init() {
    local project_dir="${1:-.}"
    cd "$project_dir"
    
    # Copy or merge base config
    ~/.config/scripts/merge-claude-config.sh
    
    # Optional: add project-specific servers
    if [ -n "$2" ]; then
        echo "Add project-specific servers to .mcp.json"
    fi
}

# change CWD on quit from yazi (q) or (Q) to stay put
function y() {
	local tmp="$(mktemp -t "yazi-cwd.XXXXXX")" cwd
	yazi "$@" --cwd-file="$tmp"
	IFS= read -r -d '' cwd < "$tmp"
	[ -n "$cwd" ] && [ "$cwd" != "$PWD" ] && builtin cd -- "$cwd"
	rm -f -- "$tmp"
}

# Starship prompt
eval "$(starship init zsh)"

# atuin (shell history)
eval "$(atuin init zsh)"
